<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.osaz.danaka.product.model.dao.ProductMapper">
    <resultMap type="com.osaz.danaka.product.model.dto.ProductDTO" id="productResultMap">
        <id property="productNo" column="PRODUCT_NO"/>
        <result property="categoryCode" column="CATEGORY_CODE"/>
        <result property="brandName" column="BRAND_NAME"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="productRegDate" column="PRODUCT_REG_DATE"/>
        <result property="stock" column="STOCK"/>
        <result property="savePath" column="SAVE_PATH"/>
        <association property="rod" resultMap="rodResultMap"></association>
        <association property="reel" resultMap="reelResultMap"></association>
        <association property="line" resultMap="lineResultMap"></association>
    </resultMap>
    <resultMap id="rodResultMap" type="com.osaz.danaka.product.model.dto.RodDTO">
        <result property="model" column="ROD_MODEL"/>
        <result property="reelType" column="ROD_REEL_TYPE"/>
        <result property="lineMin" column="LINE_MIN"/>
        <result property="lineMax" column="LINE_MAX"/>
        <result property="price" column="ROD_PRICE"/>
    </resultMap>
    <resultMap id="reelResultMap" type="com.osaz.danaka.product.model.dto.ReelDTO">
        <result property="model" column="REEL_MODEL"/>
        <result property="reelType" column="REEL_TYPE"/>
        <result property="price" column="REEL_PRICE"/>
    </resultMap>
    <resultMap id="lineResultMap" type="com.osaz.danaka.product.model.dto.LineDTO">
        <result property="lineSize" column="LINE_SIZE"/>
        <result property="price" column="LINE_PRICE"/>
    </resultMap>

    <!-- 페이징 처리를 위한 대상품 총 개수 조회 쿼리 -->
    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
            COUNT(*)
          FROM VIEW_PRODUCT
         WHERE 1 = 1
        <if test="categoryCode != null">
           AND CATEGORY_CODE = #{ categoryCode }
        </if>
           AND PRODUCT_NO IN (SELECT
                                  MIN(PRODUCT_NO)
                                FROM VIEW_PRODUCT
                               GROUP BY PRODUCT_NAME)
      <if test="searchCondition == 'productName'">
          AND PRODUCT_NAME LIKE '%' || #{ searchValue } || '%'
      </if>
    </select>
    <!-- 상품 카테고리에 따른 대상품 목록 조회 쿼리, 정렬을 위해 동적 쿼리 사용함 -->
    <select id="selectListByCategory" parameterType="com.osaz.danaka.common.SelectCriteria" resultMap="productResultMap">
        SELECT
            A.*,
            A.RNUM,
            H.SAVE_PATH
        <if test="orderCondition != null and orderCondition == 'sale'">
            ,E.TOTSALE
        </if>
          FROM (SELECT
                    B.*,
                    ROWNUM "RNUM"
                  FROM (SELECT
                            C.*
                          FROM VIEW_PRODUCT C
                         WHERE C.PRODUCT_NO IN (SELECT
                                                    MIN(F.PRODUCT_NO)
                                                  FROM VIEW_PRODUCT F
                                                 GROUP BY F.PRODUCT_NAME)
                            <if test="categoryCode != null">
                               AND C.CATEGORY_CODE = #{ categoryCode }
                            </if>
                        <choose>
                            <when test="orderCondition == null">
                                ORDER BY C.PRODUCT_NO DESC
                            </when>
                            <when test="orderCondition == 'lowPrice' and categoryCode == 'RD'">
                                ORDER BY C.ROD_PRICE ASC
                            </when>
                            <when test="orderCondition == 'highPrice' and categoryCode == 'RD'">
                                ORDER BY C.ROD_PRICE DESC
                            </when>
                            <when test="orderCondition == 'lowPrice' and categoryCode == 'RL'">
                                ORDER BY C.REEL_PRICE ASC
                            </when>
                            <when test="orderCondition == 'highPrice' and categoryCode == 'RL'">
                                ORDER BY C.REEL_PRICE DESC
                            </when>
                            <when test="orderCondition == 'lowPrice' and categoryCode == 'LN'">
                                ORDER BY C.LINE_PRICE ASC
                            </when>
                            <when test="orderCondition == 'highPrice' and categoryCode == 'LN'">
                                ORDER BY C.LINE_PRICE DESC
                            </when>
                        </choose>) B
                 ) A
          LEFT JOIN (SELECT
                         G.PRODUCT_NO,
                         G.SAVE_PATH
                       FROM T_IMG_PATH G
                      WHERE IMG_CATEGORY = 'T') H
            ON A.PRODUCT_NO = H.PRODUCT_NO
          <if test="orderCondition != null and orderCondition == 'sale'">
          LEFT JOIN (SELECT
                         D.PRODUCT_NO,
                         SUM(AMOUNT) "TOTSALE"
                       FROM T_ORDER D
                      GROUP BY D.PRODUCT_NO) E
            ON A.PRODUCT_NO = E.PRODUCT_NO
          </if>
         WHERE A.RNUM BETWEEN #{ startRow } AND #{ endRow }
    </select>
    <!-- 상품 상세 페이지를 위한 한개의 대상품 정보 조회 쿼리 -->
    <select id="selectOneProduct" parameterType="String" resultMap="productResultMap">
        SELECT
            *
          FROM VIEW_PRODUCT
         WHERE PRODUCT_NO = #{ productNo }
    </select>
    <!-- 상품 상세 페이지를 위한 같은 대상품 내에 속한 옵션 상품들 조회 쿼리 -->
    <select id="selectOptionList" parameterType="String" resultMap="productResultMap">
        SELECT
            A.CATEGORY_CODE,
            A.PRODUCT_NO,
            A.PRODUCT_NAME,
            A.BRAND_NAME,
            A.ROD_MODEL,
            A.ROD_REEL_TYPE,
            A.LINE_MIN,
            A.LINE_MAX,
            A.ROD_PRICE,
            A.REEL_MODEL,
            A.REEL_TYPE,
            A.REEL_PRICE,
            A.LINE_SIZE,
            A.LINE_PRICE,
            B.SAVE_PATH
          FROM VIEW_PRODUCT A
          LEFT JOIN T_IMG_PATH B
            ON A.PRODUCT_NO = B.PRODUCT_NO
         WHERE A.PRODUCT_NAME = #{ productName }
           AND A.PRODUCT_NO != (SELECT
                                  MIN(PRODUCT_NO)
                                FROM T_PRODUCT
                               WHERE PRODUCT_NAME = #{ productName }
                               GROUP BY PRODUCT_NAME)
         ORDER BY A.PRODUCT_NO ASC
    </select>
    <!-- 상품 상세페이지에서 해당 상품과 같은 카테고리 상품들 20개만 조회 쿼리 -->
    <select id="selectRefProducts" parameterType="String" resultMap="productResultMap">
        SELECT
            A.PRODUCT_NO,
            B.SAVE_PATH
          FROM (SELECT
                    PRODUCT_NO,
                    CATEGORY_CODE
                  FROM T_PRODUCT
                 WHERE PRODUCT_NO IN (SELECT
                                          MIN(PRODUCT_NO) "PRODUCT_NO"
                                      FROM T_PRODUCT
                                      GROUP BY PRODUCT_NAME)) A
          LEFT JOIN T_IMG_PATH B
            ON A.PRODUCT_NO = B.PRODUCT_NO
         WHERE A.CATEGORY_CODE = (SELECT
                                    C.CATEGORY_CODE
                                  FROM T_PRODUCT C
                                 WHERE C.PRODUCT_NO = #{ productNo })
           AND ROWNUM BETWEEN 1 AND 20
           AND A.PRODUCT_NO != #{ productNo }
    </select>
    <!-- 상품 상세페이지에서 해당 상품을 위시리스트에 등록하는 쿼리 -->
    <insert id="insertWishProduct" parameterType="Map">
        INSERT INTO T_WISHLIST
        VALUES
            (
             SEQ_WISH_NO.NEXTVAL,
             #{ userNo },
             #{ productNo }
            )
    </insert>
    <!-- 상품 상세페이지에서 해당 상품을 장바구니에 등록하는 쿼리 -->
    <insert id="insertCartProduct" parameterType="Map">
        INSERT INTO T_CART
        VALUES
            (
             SEQ_CART_NO.NEXTVAL,
             #{ userNo },
             #{ productNo },
             #{ amount },
             ''
            )
    </insert>
    <!-- 상품 구매시 구매내역 테이블에 데이터 추가하는 쿼리 -->
    <insert id="insertOrder" parameterType="com.osaz.danaka.product.model.dto.OrderDTO">
        INSERT INTO T_ORDER
        VALUES
            (
             SEQ_ORDER_NO.NEXTVAL,
             #{ userNo },
             #{ productNo },
             #{ orderId },
             #{ packageId },
             #{ address },
             #{ amount },
             #{ totPrice },
             #{ orderRequest },
             #{ payType },
             DEFAULT
            )
    </insert>
</mapper>